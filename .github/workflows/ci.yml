##############################
####  AUTOGENERATED       ####
####  DO NOT MODIFY!      ####
##############################
# Workflow for PR checks in module repositories
name: CI

on:
  # Start workflow on each pull request
  pull_request:

concurrency:
  # There should be only one in-progress run of this workflow at a time for a specific PR
  group: ${{ github.event.number }}
  # Cancel runs of this workflow that are currently in progess.
  cancel-in-progress: true

jobs:
  # Runs the unit test suite
  unit-tests:
    name: Run unit test suite
    # Define plenty-used variables
    env:
      # CI variables
      APP_ENV: testing
      IS_JENKINS: true
      PLENTY_ID_HASH: 1000
      WORKSPACE: ${{ github.workspace }}
      COMPOSER_HOME: "$HOME/.config/composer/vendor/bin"

      # Database variables
      DB_HOST: "127.0.0.1"
      DB_USERNAME: root
      DB_PASSWORD: test
      DB_DATABASE: mysql-test
      # Synonym database variable names (only defined because of inconsistency within plenty code)
      DB_USER: root
      DB_PASS: test
      DB_NAME: mysql-test

      QUEUE_DRIVER: sync
      SESSION_DRIVER: array
      CACHE_DRIVER: array
      BROADCAST_DRIVER: log

      # AWS environment variables
      AWS_REGION: eu-central-1

      AWS_S3_ACCESS_KEY_ID: ${{ secrets.ORGA_ACCESS_KEY_ID_AWS_S3_RW_INTEGRITYDATA }}
      AWS_S3_SECRET_ACCESS_KEY: ${{ secrets.ORGA_SECRET_ACCESS_KEY_AWS_S3_RW_INTEGRITYDATA }}

      # Uncomment following env variables if needed
      #
      # AWS_DDB_ACCESS_KEY_ID: ${{ secrets.AWS_DDB_ACCESS_KEY }}
      # AWS_DDB_SECRET_ACCESS_KEY: ${{ secrets.AWS_DDB_SECRET_ACCESS_KEY }}
      # AWS_DDB_CONNECTION: test
      # DYNAMODB_LOCAL_ENDPOINT: http://localhost:8085

    runs-on: ubuntu-latest

    # Start containers with specific services that are needed to run the unit test suite.
    # In this case we need mariadb and redis.
    # The used versions match the ones used in production.
    services:
      mariadb:
        # Uses a prewarmed db image here to speedup the migrations https://github.com/plentymarkets/prewarm-db
        image: ghcr.io/plentymarkets/prewarm-db:stable7
        credentials:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.ORGA_PAT_CICD1_PACKAGE_READ_ONLY }}
        ports:
          - 127.0.0.1:3306:3306
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.DB_PASSWORD }}
          MARIADB_DATABASE: ${{ env.DB_DATABASE }}
      redis:
        image: redis:4.0.8
        ports:
          - 127.0.0.1:6379:6379

    steps:
      - uses: plentymarkets/github-runner-cleanup@main

      - name: Checkout module
        uses: actions/checkout@v2
        with:
          path: "plenty-module"

      # Check for existing phpunit.xml. Skip unnecessary if missing.
      - name: Check for tests
        working-directory: plenty-module
        run: |
          if [[ ! -f "phpunit.xml" ]]; then
            echo "No tests. phpunit.xml not found."; exit 1;
          fi

      - name: Checkout github-actions repository
        uses: actions/checkout@v2
        with:
          repository: plentymarkets/github-actions
          ref: main
          token: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}
          path: .tmp/github-actions

      - name: Checkout PL PY PS
        id: branches
        uses: ./.tmp/github-actions/checkout_pl_py_ps/
        with:
          token: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}

      - name: Read package name from module's composer.json
        working-directory: plenty-module
        run: |
          FULL_PACKAGE_NAME=$(jq -r ".name" ./composer.json)
          PACKAGE_NAME=${FULL_PACKAGE_NAME#"plentymarkets/"}
          echo "package name is: ${PACKAGE_NAME}"
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Move module to destination (pl/packages/plentymarkets/${{ env.PACKAGE_NAME }})
        run: |
          mkdir -p pl/packages/plentymarkets
          mv "plenty-module" "pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}"

      # Set PHP version and install PHP if neccessary
      - name: Setup php
        uses: shivammathur/setup-php@da0e8547371daac1784abb79f9bb2af76dcdfaf0
        with:
          php-version: "7.3"
          extensions: ast
          coverage: none
        env:
          COMPOSER_TOKEN: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}

      # Cache dependencies to reduce traffic and cpu usage
      - name: Cache pl dependencies
        uses: actions/cache@v2
        with:
          path: "pl/vendor"
          key: ${{ runner.os }}-composer-pl-${{ hashFiles('pl/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-pl-

      - name: Install module dependencies
        working-directory: pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}/
        run: |
          touch .env
          composer install --no-progress --no-scripts

      # Install dependencies
      - name: Install dependencies
        # Change the path of the working directory to prevent running below script(s) in the workflow's working directory
        working-directory: pl
        # Remove locally stored Laravel files if they exist
        # Execute composer install without executing scripts defined in 'composer.json'
        # Search for modules
        # Enable OpenSSL OAuth encryption
        # Create an empty '.env' file ('autoloader' requires this file, even if it is empty)
        run: |
          rm -f bootstrap/cache/{services,packages}.php
          composer install --no-progress --no-scripts
          composer dump-autoload
          php artisan passport:keys
          touch .env

      # Prepare the test database
      - name: Init db
        working-directory: pl
        run: |
          php artisan migrate --database=mysql-test --env=testing
          php artisan db:seed --database=mysql-test --env=testing

      - name: Build plugin api
        working-directory: pl
        run: |
          php artisan plugin:buildinterface --without-docs --target=./storage/plugin-interface

      - name: Sync policies
        working-directory: pl
        run: |
          php artisan authorization:collect_permissions

      - name: Run module's unit test suite
        working-directory: pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}/
        run: |
          ./vendor/bin/paratest -p2 --log-junit=testresult.xml

      - name: Plugin interface build and integrity check
        working-directory: pl
        env:
          APP_ENV: pipeline
        run: |
          php artisan plugin:buildinterface --without-docs --check-integrity --target=./storage/plugin-interface

      - name: API export
        working-directory: pl
        # This step always fails that is why continue-on-error must stay here
        continue-on-error: true
        run: |
          php artisan api:export --format=OpenApi --schema=json --env=doc --parser=dev --validation-export=csv

      - name: Check API Integrity
        working-directory: pl
        run: |
          if [ -s "./storage/RestApi/rest-api-validation-errors.csv" ]; then
              cat storage/RestApi/rest-api-validation-errors.csv
              exit 1
          fi

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@bffeee8009970dbb7444de4027c06333c97a8a54
        if: always()
        with:
          files: "pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}/testresult.xml"
