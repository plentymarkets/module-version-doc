##############################
####  AUTOGENERATED       ####
####  DO NOT MODIFY!      ####
##############################
# Workflow for PR checks in module repositories
name: CI

on:
  # Start workflow on each pull request
  pull_request:

concurrency:
  # There should be only one in-progress run of this workflow at a time for a specific PR
  group: ${{ github.event.number }}
  # Cancel runs of this workflow that are currently in progess.
  cancel-in-progress: true

jobs:
  # Runs the unit test suite
  unit-tests:
    name: Run unit test suite
    strategy:
      fail-fast: false
      matrix:
        php:
          - version: 7.3
            required: true
          - version: 8.0
            required: false

    # Define plenty-used variables
    env:
      # CI variables
      APP_ENV: testing
      IS_JENKINS: true
      PLENTY_ID_HASH: 1000
      WORKSPACE: ${{ github.workspace }}
      COMPOSER_HOME: "$HOME/.config/composer/vendor/bin"

      # Database variables
      DB_HOST: "127.0.0.1"
      DB_USERNAME: root
      DB_PASSWORD: test
      DB_DATABASE: mysql-test
      # Synonym database variable names (only defined because of inconsistency within plenty code)
      DB_USER: root
      DB_PASS: test
      DB_NAME: mysql-test

      QUEUE_DRIVER: sync
      SESSION_DRIVER: array
      CACHE_DRIVER: array
      BROADCAST_DRIVER: log

      # AWS environment variables
      AWS_REGION: eu-central-1

      AWS_S3_ACCESS_KEY_ID: ${{ secrets.ORGA_ACCESS_KEY_ID_AWS_S3_RW_INTEGRITYDATA }}
      AWS_S3_SECRET_ACCESS_KEY: ${{ secrets.ORGA_SECRET_ACCESS_KEY_AWS_S3_RW_INTEGRITYDATA }}
      
      AWS_SECRETSMANAGER_ACCESS_KEY_ID: aws_secretsmanager_access_key
      AWS_SECRETSMANAGER_SECRET_ACCESS_KEY: aws_secretsmanager_secret_access_key

      STATUS_FILE: test.${{ matrix.php.version }}.status

      # Uncomment following env variables if needed
      #
      # AWS_DDB_ACCESS_KEY_ID: ${{ secrets.AWS_DDB_ACCESS_KEY }}
      # AWS_DDB_SECRET_ACCESS_KEY: ${{ secrets.AWS_DDB_SECRET_ACCESS_KEY }}
      # AWS_DDB_CONNECTION: test
      # DYNAMODB_LOCAL_ENDPOINT: http://localhost:8000

    runs-on: ubuntu-latest

    # Start containers with specific services that are needed to run the unit test suite.
    # In this case we need mariadb and redis.
    # The used versions match the ones used in production.
    services:
      mariadb:
        # Uses a prewarmed db image here to speedup the migrations https://github.com/plentymarkets/prewarm-db
        image: ghcr.io/plentymarkets/prewarm-db:stable7
        credentials:
          username: ${{ github.repository_owner }}
          password: ${{ secrets.ORGA_PAT_CICD1_PACKAGE_READ_ONLY }}
        ports:
          - 127.0.0.1:3306:3306
        env:
          MARIADB_ROOT_PASSWORD: ${{ env.DB_PASSWORD }}
          MARIADB_DATABASE: ${{ env.DB_DATABASE }}
      redis:
        image: redis:4.0.8
        ports:
          - 127.0.0.1:6379:6379

    steps:
      - uses: plentymarkets/github-runner-cleanup@main

      # Uncomment the following lines if you need DynamoDB
      # - name: Setup DynamoDB Local
      #   uses: rrainn/dynamodb-action@bcd468d7ba161c45edcd8936970f7c9632b828cd
      #   with:
      #     port: 8000
      #     cors: '*'
      #     sharedDb: test

      - name: Checkout module
        uses: actions/checkout@v3
        with:
          path: "plenty-module"

      # Check for existing phpunit.xml. Skip unnecessary if missing.
      - name: Check for tests
        working-directory: plenty-module
        run: |
          if [[ ! -f "phpunit.xml" ]]; then
            echo "No tests. phpunit.xml not found."; exit 1;
          fi

      - name: Checkout github-actions repository
        uses: actions/checkout@v3
        with:
          repository: plentymarkets/github-actions
          ref: main
          token: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}
          path: .tmp/github-actions

      - name: Checkout PL PY PS
        id: branches
        uses: ./.tmp/github-actions/checkout_pl_py_ps/
        with:
          token: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}

      - name: Read package name from module's composer.json
        working-directory: plenty-module
        run: |
          FULL_PACKAGE_NAME=$(jq -r ".name" ./composer.json)
          PACKAGE_NAME=${FULL_PACKAGE_NAME#"plentymarkets/"}
          echo "package name is: ${PACKAGE_NAME}"
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV

      - name: Move module to destination (pl/packages/plentymarkets/${{ env.PACKAGE_NAME }})
        run: |
          mkdir -p pl/packages/plentymarkets
          mv "plenty-module" "pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}"

      # Set PHP version and install PHP if neccessary
      - name: Setup php
        uses: shivammathur/setup-php@b75c104ca87c371bbc71be81a4e5dd5a5d298241
        with:
          php-version: ${{ matrix.php.version }}
          extensions: ast
          coverage: none
        env:
          COMPOSER_TOKEN: ${{ secrets.ORGA_PAT_CICD1_FULL_REPO_AND_PACKAGES }}

      # Cache dependencies to reduce traffic and cpu usage
      - name: Cache pl dependencies
        uses: actions/cache@v3
        with:
          path: "pl/vendor"
          key: ${{ runner.os }}-composer-pl-${{ hashFiles('pl/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-pl-

      - name: Install module dependencies
        working-directory: pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}/
        run: |
          touch .env
          composer install --no-progress --no-scripts

      # Install dependencies
      - name: Install dependencies
        # Change the path of the working directory to prevent running below script(s) in the workflow's working directory
        working-directory: pl
        # Remove locally stored Laravel files if they exist
        # Execute composer install without executing scripts defined in 'composer.json'
        # Search for modules
        # Enable OpenSSL OAuth encryption
        # Create an empty '.env' file ('autoloader' requires this file, even if it is empty)
        run: |
          rm -f bootstrap/cache/{services,packages}.php
          composer install --no-progress --no-scripts
          composer dump-autoload
          php artisan passport:keys
          touch .env

      # Prepare the test database
      - name: Init db
        working-directory: pl
        run: |
          php artisan migrate --database=mysql-test --env=testing
          php artisan db:seed --database=mysql-test --env=testing

      - name: Build plugin api
        working-directory: pl
        run: |
          php artisan plugin:buildinterface --without-docs --target=./storage/plugin-interface

      - name: Sync policies
        working-directory: pl
        run: |
          php artisan authorization:collect_permissions

      - name: Run module's unit test suite
        working-directory: pl/packages/plentymarkets/${{ env.PACKAGE_NAME }}/
        run: |
          ./vendor/bin/paratest -p2 --log-junit=${{ runner.temp }}/testresult.${{ matrix.php.version }}.xml

      - name: Upload unit test result artifact
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: junit
          path: ${{ runner.temp }}/testresult.${{ matrix.php.version }}.xml

      - name: Plugin interface build and integrity check
        working-directory: pl
        env:
          APP_ENV: pipeline
        run: |
          php artisan plugin:buildinterface --without-docs --check-integrity --target=./storage/plugin-interface

      - name: API export
        working-directory: pl
        # This step always fails that is why continue-on-error must stay here
        continue-on-error: true
        run: |
          php artisan api:export --format=OpenApi --schema=json --env=doc --parser=dev --validation-export=csv

      - name: Check API Integrity
        working-directory: pl
        run: |
          if [ -s "./storage/RestApi/rest-api-validation-errors.csv" ]; then
              cat storage/RestApi/rest-api-validation-errors.csv
              exit 1
          fi

      - name: Set job status
        if: always()
        run: |
          echo "${{ job.status }}" > "${RUNNER_TEMP}/${STATUS_FILE}"

          # add "optional" if test is not required
          if ! ${{ matrix.php.required }}; then
            echo " optional" >> "${RUNNER_TEMP}/${STATUS_FILE}"
          fi

      - name: Upload matrix status artifact
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: job-status
          path: ${{ runner.temp }}/${{ env.STATUS_FILE }}

  collect-results:
    # checks results of all previous jobs for failures
    needs: unit-tests
    name: Test overall status
    runs-on: ["self-hosted", "stable", "medium", "spot"]
    if: always()
    steps:
      - uses: plentymarkets/github-runner-cleanup@main

      - name: Download artifacts
        uses: actions/download-artifact@v2

      - name: Summarize jobs status
        shell: bash
        run: |
          FILES=$(find "./job-status" -type f -name "test.*.status")

          OVERALL_STATUS="success"

          RED='\033[0;31m'
          NC='\033[0m'

          while IFS="" read -r FILE; do

            FILENAME=$(basename "${FILE}")
            STATUS=$(cat "$FILE" | xargs)

            printf "${FILENAME}: "

            if [[ "$STATUS" != "success"* ]]; then

              printf "${RED}${STATUS}${NC}\n"

              if [[ "$STATUS" != *"optional"* ]]; then
                OVERALL_STATUS=$STATUS
              fi
            else
              echo "${STATUS}"
            fi

          done <<< "$FILES"

          if [[ "$OVERALL_STATUS" != "success" ]]; then
            printf "\n${RED}At least one required job failed!${NC}\n"
            exit 1
          else
            printf "\nAll required jobs were successful.\n"
          fi

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@4a00ba50806e7658e5005bb91acdb3274714595a
        if: always()
        with:
          files: junit/testresult.*.xml
